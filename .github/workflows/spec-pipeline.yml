name: Spec Pipeline CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e .
        python -m pip install pytest
    
    - name: Run tests
      run: pytest -q
      continue-on-error: false

    - name: Run self-host tests specifically
      run: pytest -q tests/selfhost -q

    - name: Ensure critical tests exist
      run: |
        python - <<PY
        import pathlib, sys
        repo = pathlib.Path('.').resolve()
        txt = repo.read_text()
        required = [
          'test_selfhost_roundtrip_identity',
          'test_selfhost_closed_loop_determinism',
          'test_sync_authority_compare',
          'test_snapshot_detects_change'
        ]
        missing = [r for r in required if r not in txt]
        if missing:
            print('Missing critical tests:', missing)
            sys.exit(2)
        print('Critical tests present')
        PY
    
    - name: Check generator lockfile version
      run: |
        python -c "
        import json
        spec = json.load(open('spec/se_dsl_v1.spec.json'))
        lockfile = json.load(open('generators/lockfile.json'))
        spec_version = spec['metadata'].get('generator_version', 'missing')
        lock_version = lockfile.get('generator_version', 'missing')
        if spec_version != lock_version:
            print(f'ERROR: Generator version mismatch')
            print(f'  Spec: {spec_version}')
            print(f'  Lockfile: {lock_version}')
            exit(1)
        print(f'Generator version match: {spec_version}')
        "
    
    - name: Run spec pipeline dry-run
      run: |
        if [ -f scripts/verify_spec_pipeline.py ]; then
          python -m scripts.verify_spec_pipeline --dry-run || true
        fi
      continue-on-error: true
    
    - name: Upload test failure summary
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-failures
        path: artifacts/test_failures/summary.txt
        if-no-files-found: ignore
