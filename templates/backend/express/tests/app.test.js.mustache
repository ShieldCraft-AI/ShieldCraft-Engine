// Test suite
// Generated by ShieldCraft Engine v1.0

const request = require('supertest');
const mongoose = require('mongoose');
const { MongoMemoryServer } = require('mongodb-memory-server');
const app = require('../app');
// const { Task, User } = require('../models');

let mongoServer;

// Setup before all tests
beforeAll(async () => {
  // Start in-memory MongoDB
  mongoServer = await MongoMemoryServer.create();
  const mongoUri = mongoServer.getUri();
  await mongoose.connect(mongoUri);
});

// Cleanup after all tests
afterAll(async () => {
  await mongoose.disconnect();
  await mongoServer.stop();
});

// Clear database before each test
beforeEach(async () => {
  const collections = mongoose.connection.collections;
  for (const key in collections) {
    const collection = collections[key];
    await collection.deleteMany({});
  }
});

// Test data
const testUser = {
  username: 'testuser',
  email: 'test@example.com',
  fullName: 'Test User',
  password: 'password123'
};

const testTask = {
  title: 'Test Task',
  description: 'This is a test task',
  completed: false,
  priority: 'medium'
};

// Basic app tests
describe('App', () => {
  test('should respond to health check', async () => {
    const response = await request(app).get('/health');
    expect(response.status).toBe(200);
    expect(response.body.status).toBe('healthy');
  });

  test('should respond to detailed health check', async () => {
    const response = await request(app).get('/health/detailed');
    expect(response.status).toBe(200);
    expect(response.body.status).toBe('healthy');
    expect(response.body).toHaveProperty('services');
    expect(response.body).toHaveProperty('uptime');
  });
});

// Entity-specific tests (to be expanded based on spec)
{{ entity_tests }}

// Example test implementations (to be replaced by generated tests)
/*
// User tests
describe('Users API', () => {
  test('should create a new user', async () => {
    const response = await request(app)
      .post('/api/users')
      .send(testUser);

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
    expect(response.body.data).toHaveProperty('_id');
    expect(response.body.data.username).toBe(testUser.username);
  });

  test('should get all users', async () => {
    // Create a user first
    await request(app).post('/api/users').send(testUser);

    const response = await request(app).get('/api/users');
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(Array.isArray(response.body.data)).toBe(true);
    expect(response.body.data.length).toBeGreaterThan(0);
  });

  test('should return 404 for non-existent user', async () => {
    const response = await request(app).get('/api/users/507f1f77bcf86cd799439011');
    expect(response.status).toBe(404);
    expect(response.body.success).toBe(false);
  });
});

// Task tests
describe('Tasks API', () => {
  let userId;
  let authToken;

  beforeEach(async () => {
    // Create user and get token
    const userResponse = await request(app)
      .post('/api/users')
      .send(testUser);

    userId = userResponse.body.data._id;

    // Login to get token (assuming auth endpoint exists)
    // const loginResponse = await request(app)
    //   .post('/api/auth/login')
    //   .send({ email: testUser.email, password: testUser.password });
    // authToken = loginResponse.body.data.token;
  });

  test('should create a new task', async () => {
    const taskData = { ...testTask, userId };

    const response = await request(app)
      .post('/api/tasks')
      .set('Authorization', `Bearer ${authToken}`)
      .send(taskData);

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
    expect(response.body.data.title).toBe(testTask.title);
  });

  test('should get tasks with pagination', async () => {
    // Create multiple tasks
    const tasks = Array.from({ length: 5 }, (_, i) => ({
      ...testTask,
      title: `Task ${i + 1}`,
      userId
    }));

    for (const task of tasks) {
      await request(app)
        .post('/api/tasks')
        .set('Authorization', `Bearer ${authToken}`)
        .send(task);
    }

    const response = await request(app)
      .get('/api/tasks?page=1&limit=3')
      .set('Authorization', `Bearer ${authToken}`);

    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data.items.length).toBe(3);
    expect(response.body.data).toHaveProperty('total');
    expect(response.body.data).toHaveProperty('page');
  });

  test('should update a task', async () => {
    // Create task
    const createResponse = await request(app)
      .post('/api/tasks')
      .set('Authorization', `Bearer ${authToken}`)
      .send({ ...testTask, userId });

    const taskId = createResponse.body.data._id;

    // Update task
    const updateResponse = await request(app)
      .put(`/api/tasks/${taskId}`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({ title: 'Updated Task', completed: true });

    expect(updateResponse.status).toBe(200);
    expect(updateResponse.body.success).toBe(true);
    expect(updateResponse.body.data.title).toBe('Updated Task');
    expect(updateResponse.body.data.completed).toBe(true);
  });

  test('should delete a task', async () => {
    // Create task
    const createResponse = await request(app)
      .post('/api/tasks')
      .set('Authorization', `Bearer ${authToken}`)
      .send({ ...testTask, userId });

    const taskId = createResponse.body.data._id;

    // Delete task
    const deleteResponse = await request(app)
      .delete(`/api/tasks/${taskId}`)
      .set('Authorization', `Bearer ${authToken}`);

    expect(deleteResponse.status).toBe(200);
    expect(deleteResponse.body.success).toBe(true);

    // Verify deletion
    const getResponse = await request(app)
      .get(`/api/tasks/${taskId}`)
      .set('Authorization', `Bearer ${authToken}`);

    expect(getResponse.status).toBe(404);
  });
});

// Authentication tests (if auth is implemented)
describe('Authentication', () => {
  test('should login with valid credentials', async () => {
    // Create user first
    await request(app).post('/api/users').send(testUser);

    const response = await request(app)
      .post('/api/auth/login')
      .send({
        email: testUser.email,
        password: testUser.password
      });

    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data).toHaveProperty('token');
  });

  test('should reject invalid credentials', async () => {
    const response = await request(app)
      .post('/api/auth/login')
      .send({
        email: 'invalid@example.com',
        password: 'wrongpassword'
      });

    expect(response.status).toBe(401);
    expect(response.body.success).toBe(false);
  });
});
*/

// Placeholder for generated tests
describe('Generated Tests', () => {
  test('should have generated tests', () => {
    expect(true).toBe(true); // Placeholder
  });
});